<%#
kind: ptable
name: kickstart boot+data by-id WIP
model: Ptable
oses:
- AlmaLinux
- CentOS
- CentOS_Stream
- Fedora
- RedHat
- Rocky
%>

#Dynamic

# run `nc -k -l 8999` on foreman host to capture disk information
echo "###" | nc <%= foreman_server_fqdn %> 8999 || true
hostname -f | nc <%= foreman_server_fqdn %> 8999 || true
ls -laR /dev/disk | nc <%= foreman_server_fqdn %> 8999 || true
echo "###" | nc <%= foreman_server_fqdn %> 8999 || true

BOOT_DEV="/dev/disk/by-id/<%= host_param('boot_disk_id') %>"
BOOT_VG="boot_$(hostname -s)"

<% if host_param('data_disk_id') %>
DATA_DEV="/dev/disk/by-id/<%= host_param('data_disk_id') %>"
DATA_VG="data_$(hostname -s)"
DATA_PATH="<%= host_param('data_path') or '/data' %>"
ALL_DEVS="${BOOT_DEV},${DATA_DEV}"
<% else%>
ALL_DEVS="${BOOT_DEV}"
<% end %>

cat <<EOF > /tmp/diskpart.cfg
ignoredisk --only-use=${ALL_DEVS}
zerombr
clearpart --drives=${ALL_DEVS} --all --initlabel --disklabel=gpt

part /boot     --size=1024 --asprimary --ondrive=${BOOT_DEV} --fstype=ext4
part /boot/efi --size=200  --asprimary --ondrive=${BOOT_DEV} --fstype=efi
part pv.boot   --size=1 --grow --ondisk=${BOOT_DEV}
volgroup ${BOOT_VG} pv.boot

<% if host_param('data_disk_id') %>
part pv.data   --size=1 --grow --ondisk=${DATA_DEV}
volgroup ${DATA_VG} pv.data
<% end %>

logvol /               --vgname=${BOOT_VG} --size=<%= host_param('root_lv_size') or 51200 %> --name=root --fstype=ext4
<% if host_param('home_lv_size') -%>
logvol /home           --vgname=${BOOT_VG} --size=<%= host_param('home_lv_size') %> --name=home --fstype=ext4
<% end -%>
<% if host_param('var_lv_size') -%>
logvol /var            --vgname=${BOOT_VG} --size=<%= host_param('var_lv_size') %> --name=var --fstype=ext4
<% end -%>
<% if host_param('docker_lv_size') -%>
logvol /var/lib/docker --vgname=${BOOT_VG} --size=<%= host_param('docker_lv_size') %> --name=docker
<% end -%>
<% if host_param('data_disk_id') %>
logvol ${DATA_PATH}    --vgname=${DATA_VG} --size=1 --grow --name=data --fstype=xfs
<% end %>
EOF
